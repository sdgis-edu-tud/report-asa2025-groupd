---
title: "Targeting Climate Adaptation Measures Along the Bílá Nisa Stream"
subtitle: "Project report of Group D"
author:
  - name: "Frederick Auer"
    affiliation: "MSc Geomatics"
    group_role: "Software/Program Helper & Data Collector"
  - name: "Lin Ruofan"
    affiliation: "MSc Landscape Architecture"
    group_role: "Mapping Specialist & Design Lead"
  - name: "Matthijs Jerez Nova"
    affiliation: "MSc Urbanism"
    group_role: "Writer/Editor & Research Lead"
  - name: "Ula Kunigelyte"
    affiliation: "MSc Urbanism"
    group_role: "Mapping Specialist & Data Analyst"
  - name: "Finn van Asch"
    affiliation: "MSc Urbanism"
    group_role: "Research Lead & Assistant Mapping Specialist"

bibliography: references.bib
csl: apa.csl

format: html

editor: visual
---

```{r}
#| label: setup


```

**Table of contents:**

1.  Introduction;
2.  Methodology;
    a.  Spatial Multi-Criteria Decision Analysis (S-MCDA)
    b.  Typology Construction (K-Means Clustering)
    c.  Definition of Spatial Units;
    d.  Resolution and Data Acquisition Methods
    e.  Normalization;
3.  Spatial Multi-Criteria Decision Analysis (S-MCDA)
    A.  Biodiversity;
        a.  Which Areas Have High Biodiversity Value?
        b.  Which Areas Have a High Level of Human Activity?
        c.  Which Areas Provide Opportunity for Improved Biodiversity?
    B.  Climate Adaptation;
        a.  Which Areas Have Highest Flood Damage Risk?
        b.  Which Areas Have The Most Impervious Surfaces?
        c.  Which Areas Have Healthy Vegetation?
    C.  Quality of Life;
        a.  Which Areas Are Deprived of Public Facilities?
        b.  Which Areas Lack Infrastructure to Access?
        c.  Which Areas Can Be Physically Uncomfortable?
    D.  Conclusion of S-MCDA;
4.  Typology Construction;
    a.  Research Question & Variables;
    b.  Methodology;
    c.  Results;
5.  Discussion;
6.  Conclusion;
7.  Appendix.

## 1. Introduction

Urban areas across Europe are increasingly challenged by the impacts of climate change, biodiversity loss and the demand for sustainable development [@nijkamp2013new]. According to @article, in cities the impact of land use on fresh-water ecosystems is especially severe. As climate change is expected to increase the intensity and frequency of extreme weather events, solutions to combat these effects are urgently needed [@ourloglou2020assessing].

Urban streams are expected to have an important role in the mitigation of climate change by buffering extreme temperatures and prevent floods. More importantly, finding nature-based solutions are key and can restore existing strained water systems [@ourloglou2020assessing]. In this context, spatial analytics can play a crucial role in informing climate adaptation and urban planning strategies [@hurlimann2012role]. Through methods such as Spatial Multi-Criteria Decision Analysis (S-MCDA) and typology development, planners and designers can better understand urban systems, evaluate trade-offs, and propose the correct targeted interventions.

The ReBioClim project, funded by the Interreg Central Europe Program [@rebioclim2024], exemplifies this approach by focusing on revitalizing small urban streams. It additionally provides a framework where nature-based solutions can be identified to enhance biodiversity, mitigate climate change effects, and improve urban living conditions [@rebioclim_ioer2024]. Running from June 2024 to January 2027, the project addresses the challenges of urban stream restoration in four Central European cities, including Jablonec nad Nisou, the case targeted in this report.

![ReBioClim Project Overview](Inserted_images/rebioclim_currentstate.png){width="600"}

Over recent decades, Jablonec nad Nisou has experienced overbuilding, channelization, and neglect of its urban streams, leading to ecological degradation and reduced quality of life. Our objective is to quantitatively assess the current state of these waterways and identify areas with the highest potential for improvement. Through these efforts, we aim to provide a better understanding of where and how to restore the waterways and create green-blue corridors that offer cooling effects, improve air quality, and provide recreational spaces for residents.

```{r fig.subcap="Jablonec nad Nisou and the Bila Nisa stream"}
#| warning: false
#| echo: false
#| message: false
library(leaflet)
library(sf)

# Read the stream GeoJSON
stream <- st_read("Inserted_images/stream_for_interactivemap.geojson", quiet = TRUE)

# Coordinates for Jablonec nad Nisou
jablonec_coords <- c(lat = 50.7224, lng = 15.1708)

# Render leaflet map with zoom control and max bounds
leaflet(options = leafletOptions(minZoom = 12, maxZoom = 17)) %>%
  addTiles() %>%
  setView(lng = jablonec_coords["lng"], lat = jablonec_coords["lat"], zoom = 13) %>%
  setMaxBounds(
    lat1 = 50.60, lng1 = 15.10,
    lat2 = 50.80, lng2 = 15.24
  ) %>%
  addPolylines(
    data = stream,
    color = "blue",
    weight = 3,
    opacity = 0.8,
    popup = "Bílá Nisa Stream"
  ) %>%
  addCircleMarkers(
    lng = jablonec_coords["lng"],
    lat = jablonec_coords["lat"],
    radius = 6,
    color = "red",
    fillOpacity = 0.8,
    label = "Jablonec nad Nisou"
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("blue", "red"),
    labels = c("Bílá Nisa Stream", "Jablonec nad Nisou"),
    title = "Legend",
    opacity = 0.8
  )
```

Our research centers on the Bílá Nisa stream, and will address the problems we have identified through the lens fo the three following goals: Biodiversity, Climate Adaptation, and Quality of Life. These goals, relevant to our location has led to our main research question:

> *How can an integrated urban stream restoration project in Jablonec nad Nisou balance diverse stakeholder interests by identifying areas where improvement in biodiversity, flood risk reduction, and improvements in quality of life can take place?*

Our derived sub-questions, respective to each goal are then the following:

> *Where can the ecological quality of the stream area be enhanced?*

> *Where along the stream can flood mitigation measures take place?*

> *Which areas along the stream need improvements for quality of life to address stakeholder conflicts?*

![Workflow chart](Inserted_images/General%20Images/Problem%20statement%20&%20research%20question%20(workflow).jpg)

## 2. Methodology

Methodological decisions such as the spatial scale, unit configuration, and data resolution directly influences the insights that can be drawn from the spatial analysis results [@dungan2002balanced]. The description of methodology makes it possible to reproduce the conducted analysis and provides critical context for interpreting results. The decisions made for the analysis methodology are structured around principles derived from literature, geographical context and data availability.

### 2.a. Spatial Multi-Criteria Decision Analysis (S-MCDA)

S-MCDA is an analytical process which specifically considers numerous objectives and criteria. It aggregates diverse data types and conflicting perspectives into synthetic results which can be used for a structured decision-making process. In the case of this report, the objectives are ecological improvement, flood protection and balancing stakeholder interests (see previous chapter). The specific criteria are named in Chapter 3: Spatial Multi-Criteria Decision Analysis.

### 2.b. Typology Construction (K-Means Clustering)

After conducting S-MCDA, the next step is to conduct a typology construction. This analysis looks at the different attributes of urban spaces and identifies spatial patterns and group them. This makes it possible to quantitatively compare the performance of different typologies to formulate different design intervention recommendations. For this report, the typology construction utilizes K-means cluster analysis, which identifies clusters by minimizing the sum of distances between the data points and their respective centroids (cluster centers).

### 2.c. Definition of Spatial Units

To conduct a meaningful spatial analysis, the study area must be divided into standardized spatial units. The unit is used for consistency in the assignment of spatial indicators. It also facilitates the aggregation and comparison of data across the urban landscape. For example, studies on urban heat island and green infrastructure use a regular grid of 50 x 50 meter cells as the base unit of analysis [@BARTESAGHIKOC2020103893]. Alternatively, @burdziej2019using uses a hexagonal grid where each hexagon has a side length of 100 m, selected based on the size of the study area (Toruń, Poland) and the intended spatial resolution of the study.

The definition of the spatial units was decided based on the size of Jablonec nad Nisou and the Bílá Nisa stream. A 100-meter radius buffer around the stream was selected, over which a grid of 100x100 meters was overlayed. This proved to be a good level of detail for the spatial analysis of the stream in the rural areas, while also being compatible with the available spatial raster data for the area. However, in the urban area of Jablonec and Nisou, the variation in spatial features and characteristics is significantly higher than in the outskirts of the city. The 100x100 meter grid would average out most values to an extent that the analysis would not show meaningful results. In addition, the urban stream restoration project requires the attention to be focused within the city, not in its outskirts.

To make sure that sufficient level of detail and attention is given to the urban area of Jablonec nad Nisou, and that the entire stream is still analyzed, the choice was made for the grid to be further divided into 50x50 meters inside the Jablonec and Nisou city borders. The higher level of detail provides more accuracy in the higher level of variation in spatial characteristics in the city compared to the rural area. The choice in different grid cell sizes means that only certain analysis methods (namely density, percentage) can be used to preserve standardization and comparability between different cells.

100 meters is a common grid cell size used in the spatial analysis of general environmental conditions, as can be seen in reports on mitigating heat stress [@Wang_et_al_2022], land use, population, economic [@Paprotny_Mengel_2022] and urban heat islands [@Lauwaet_et_al_2023] analysis. Meanwhile a raster size of 50 meters is more useful in analysis where spatial conditions, characteristics and typo-morphologies are examined, along with their influence on environmental conditions (see reports: @Chen_et_al_2023 ; @Song_et_al_2020 ; @Wong_et_al_2012).

![Spatial Unit Definition](Inserted_images/General%20Images/Spatial%20Unit%20Definition-01.png)

### 2.d. Resolution and Data Acquisition Method

The spatial analysis uses secondary data retrieved mostly from Czech governmental agencies and organizations, as well as Geofabrik and the European Space Agency (the source is specified for each map further in the report). The limited availability of data resulted in the need to consider data of varying resolution levels and types (vector and raster). The resolution of spatial data is directly tied to the data acquisition method [@BARTESAGHIKOC2020103893].

For indicators such as air pollution, the measurement method (space-borne remote sensing) is better suited for large-scale urban assessments, the limited data availability resulted in the need to use data that may lack the spatial precision needed for detailed micro-climatic or ecological studies. On the other hand, data on biodiversity and quality of life is generally more well-documented, detailed and accessible. In these cases, a higher resolution is possible for the analysis.

The conducted analysis reflects this variation, using satellite data for broader patterns such as LST and impervious surfaces. This data is then supplemented with higher-resolution sources for space syntax calculations, biotope values and ecologically valuable habitats, to name a few.

The selected criteria for each respective goals can be found in the figures below.

```{r}
#| warning: false
#| echo: false
#| message: false

library(slickR)
library(htmltools)

imgs <- c("Inserted_images/General Images/data_biodiversity.png",
          "Inserted_images/General Images/climate_adaption.png",
          "Inserted_images/General Images/qualityoflife_datacollected.png")

# Create HTML img tags with responsive styling
img_tags <- lapply(imgs, function(img) {
  tags$img(src = img, style = "max-width:100%; height:auto; display:block; margin-left:auto; margin-right:auto;")
})

# Render the carousel with settings
slickR(obj = img_tags) + 
  settings(dots = TRUE, infinite = TRUE, autoplay = TRUE)

```

### 2.e. Normalization

The data used in this study comes from many different sources and uses different units, as discussed above. Therefore, for the spatial data to be comparable, all values need to be brought to the same scale and unit of measurement (i.e. normalized). In these conditions the data values can be combined and compared to provide meaningful results and form typology clusters.

Due to the varying data types and resolutions, different methods for normalization are used. Each spatial dataset uses its own way of normalizing respective to the data type, acquisition and availability. Each method is explained in the following sections under their respective topic and/or map that they relate to.

## 3. Spatial Multi-Criteria Decision Analysis (S-MCDA)

The S-MCDA utilizes various criteria and sub-questions to answer the research questions:

> *Where can the ecological quality of the stream area be enhanced? (Biodiversity)*

> *Where along the stream can flood mitigation measures take place? (Climate Adaptation)*

> *Which areas along the stream need improvements for quality of life to address stakeholder conflicts? (Quality of Life)*

The choice of criteria are based on scientific research, as well as data availability for Jablonec nad Nisou. For each criterion, a chosen dataset is analysed, treated and normalized to make them comparable.

For each theme, the criteria are weighed based on their relative importance for the research question utilizing the Saaty matrix (also known as the analytic hierarchy process). @FuzzyAHP was used for the construction of the Saaty matrix. The normalized values of all criteria in a given theme are aggregated and then combined to get concluding maps which identify key areas for potential design intervention. Maps showing the untreated data which was used for the conducted analysis can be found in the appendix.


### 3.A. Biodiversity

! introduction

The research area is currently dealing with challenges of ecological degradation due to past industrial activities. Therefore the biodiversity analysis aims to follow the following question:

> *Where can the ecological quality of the stream area be enhanced?*

![Aggregated Biodiversity Criteria](Inserted_images/General%20Images/Aggregated%20Biodiversity%20Criteria-01.png)

#### Which Areas Have High Biodiversity Value?

Areas with an already high value for biodiversity are vital to preserve. It is much harder to restore biodiversity to its original levels than it is to preserve it. Therefore it is vital to keep track of areas valuable for biodiversity, and avoid influencing them with human activity. In addition, the existing biodiverse areas can act as building blocks for the expansion of the green network, and can be further improved through targeted design interventions.

```{r}
#| echo: false
#| warning: false
#| message: false
library(slickR)


imgs <- c("Inserted_images/Biodiversity/Floodplain%20biotope%20value%20(normalized%20data).png",
          "Inserted_images/Biodiversity/Floodplain%20biotope%20value%20(original%20data).png")

slickR(imgs, height = 800, width = 600) +
  settings(dots = TRUE)

```

***Floodplain Biotope Value***

The purpose of this criteria is to identify which Bílá Nisa floodplains serve as natural habitats and support local biodiversity. This criterion uses the 'Categorization of Floodplains' layer taken from the Agency for Nature and Landscape Conservation of the Czech Republic. The layer was developed as a practical decision-making tool to aid for the protection of significant landscape elements in the country by identifying their characteristics and value. (APOK ČR, 2022). Since the layer source does not clearly state the methodology of determining the floodplain biotope value, this criterion is given relatively low weight.

The layer shows that most of the Bílá Nisa floodplain has negligible biotope value. However, some patches of moderate value remain which could be salvaged. To normalize this information, the polygons with moderate biotope value were isolated and 'intersected' according to the grid lines. Then an 'overlap analysis' was conducted to calculate the percentage of area per cell that has moderate floodplain biotope value.


![Floodplain Biotope Value (normalized data)](Inserted_images/Biodiversity/Floodplain%20biotope%20value%20(normalized%20data).png)

***Diversity of Natural Habitats***

Habitat diversity enables interaction, support and exchange of materials and energy between different habitat types, which improves local biodiversity and resilience [@Alsterberg_et_al_2017].  Habitat diversity is highly important for the overall biodiversity and ecosystem stability, therefore it is a criteria that has significant weight.

The diversity of natural habitats criterion examines the basic habitat mapping of the stream area retrieved from the Agency for Nature and Landscape Conservation of the Czech Republic (APOK ČR, 2025). This dataset maps the distribution of habitat types in the form of biomes. The detailed biomes are classified according to the Biotope Catalogue of The Czech Republic and include biomes which are influenced by human activity (APOK ČR, 2010).

For the analysis of the diversity of natural habitats, anthropogenic biomes (coded as X) were excluded from the dataset, as those are generally less threatened and less biodiverse than their natural counterparts in urbanized areas [@Pekin_Pijanowski_2012]. The original data map shows the detailed natural habitats along Bila Nisa which are less than 50% anthropogenic.

To normalize the data, these natural habitat polygons were split up based on the grid lines using the 'intersection' function, and then each polygon was converted into a centroid. Afterwards, the 'join attributes by location (summary)' function was used to identify the number of unique habitat values in each cell. To address the difference in cell size between inside and outside city borders, for each cell the number of unique values were divided by the surface area of the grid cell. The resulting values were divided by the largest value to get a normalized value from 0 to 1.

The map shows that there the largest diversity of natural habitats is right at the edges of the city borders.

![Diversity of Natural Habitats (normalized data)](Inserted_images/Biodiversity/Diversity%20of%20natural%20habitats%20(normalized%20data).png.png)

***Proportion of Natural Habitat Area***

The surface area of natural habitats directly influences biodiversity and ecosystem health (@Ye_et_al_2025). Therefore it is important to identify areas which have the highest proportion of natural habitat area in a given site.

This criterion looks at the same data as the diversity of natural habitats, categorized in broader natural habitat types (APOK ČR, 2025). The map shows a prominence of grasslands outside of the city, but there are also forests, shrubs and peat bogs. The polygons of these natural habitats were divided based on grid lines using the 'intersection' tool, and then an 'overlap analysis' was conducted to identify the cover area of these combined natural habitats in each cell. The map shows that most of the natural habitats area actually concentrated further away from the stream.


![Proportion of Natural Habitat Area (normalized data)](Inserted_images/Biodiversity/Natural%20habitats%20-%20cover%20area%20(normalized%20data).png)

#### Which Areas Have a High Level of Human Activity?

The presence of human activity is generally harms biodiversity, generally in the form of habitat destruction and lifestyle disturbance. Therefore areas where human activity is high may not be very effective locations to improve biodiversity.

This question has low weight compared to other questions. While a high level of human activity is undesirable for a biodiverse area, by all means it should not discourage efforts in trying to improve the ecological quality of a given location. The attributes considered in this question will be inverted for the final aggregation.

***Weighed Road Segment Length***

Roads act as physical barriers for wildlife, deterring animals from crossing, thereby fragmenting ecosystems, limiting migration and making them less resilient. Furthermore, even slow traffic roads increase the threat of bugs or animals being hit or run over by a car. Meanwhile diffuse pollution from tyre particles, gas leaks and window cleaning fluids threaten the health of ecosystems (Marcantionio_et_al_2013).

Therefore, this criterion looks at the existing road infrastructure and its speed limits, aiming to grasp the level of harm that vehicles and road infrastructure may cause to the biodiversity. The criterion looks at data of road length per cell, as well as its speed limit to estimate the impact that the roads would have on biodiversity in a given cell.

The road infrastructure was taken from OpenStreetMap and clipped to the grid. The road segments were then 'intersected' according to the grid lines. The length of each road segment was multiplied by its speed limit to adjust for the impact that vehicle speeds would have on the biodiversity. Each line segment was then converted into a centroid, and the 'join attributes by location (summary)' function was used to find the sum of all of the given values within a cell. Then the data was normalized by dividing all values by the highest value. It is important to note that for the later aggregation, the values in this criterion had to be inverted, as a larger presence of roads is undesirable for biodiversity.


![Weighed Road Segment Length (normalized data)](Inserted_images/Biodiversity/Weighed%20road%20segment%20lenght%20(normalized%20data).png)

***Proportion of Built-up Area***

Urbanization intensity negatively influences local biodiversity both directly and indirectly [@Liu_Liu_wu_2025]. Proportion of built-up area gives a clue of how intensely various parts of the study area are urbanized.

The build-up area criterion utilizes the data on existing buildings from OpenStreetMap (2025) to estimate the level of human activity in each cell (OpenStreetMap, 2025). The 'intersection' function in QGIS split up the building polygons according to the grid lines. Afterwards, an 'overlap analysis' was conducted to calculate the percentage of area that is built-up within a given cell. In essence, the build-up area normalized value looks at the Floor Space Index (FSI) of each cell.

The results of the normalized data on build-up area show that there is some level of build-up along most parts of the stream. There is a fairly high variation of build-up area along the stream in the inner city. For the later aggregation, the values in this criterion had to be inverted, as it is undesirable for biodiversity to have a high level of build-up.

![Proportion of Built-up Area (normalized data)](Inserted_images/Biodiversity/Built-up%20area%20(normalized%20data).png)

#### Which Areas Provide Opportunity for Improved Biodiversity?

Areas with certain existing spatial conditions may be easier to transform for improved biodiversity than others. Identifying these areas mean identifying locations which have the highest potential for improvement with minimum effort.

The following figure shows the criteria for each biodiversity sub-question, along with the weight of each attribute. The weights of the attributes are combined to see the weight of each sub-question, and the weight of each value all adds up to one. It is important to note that the values for weighed road segment length and proportion of built-up area had to be inverted for the aggregation. Differently from other biodiversity criteria, these attributes are undesirable. Therefore a higher proportion of built-up area and weighed road segment length would result in a poor score.

***Ecological Corridors***

Ecological corridors criterion looks at the defined ecological corridors to identify opportunities to not only improve the local biodiversity, but enhance the ecological network on the local, regional and inter-regional scale.

The data used for this criterion is the 'Methodologically Unified Definition of The Territorial System of Ecological Stability' from the Agency for Nature and Landscape Conservation of the Czech Republic (AOPK ČR, 2025). The dataset methodologically determined all hierarchial levels and types of territories which are vital for ecological stability.

To normalize this data, the layer polygons were split up per cell using the 'intersect' function, and the 'overlap analysis' was conducted to identify the percentage of area per cell that is taken up by the ecological corridor polygon. In the resulting map (where 1 is 100% of the area and 0 is 0% of the area) key cells for ecological connectivity can be seen.

![Ecological Corridors (normalized data)](Inserted_images/Biodiversity/Ecological%20corridors%20(normalized%20data).png)

***Potential for Natural Floodplain Restoration***

For the natural floodplain restoration potential criterion, the 'Categorization of Floodplains' layer of the Agency for Nature and Landscape Conservation of the Czech Republic is used. As previously mentioned, the layer was developed as a practical decision-making tool to aid for the protection of significant landscape elements in the country by identifying their characteristics and value. Unfortunately, the source does not explicitly state the methodology of how these potentials were determined (APOK ČR, 2022).

To normalize this data, the polygons with medium and high potential for restoration were isolated. Since there are not many areas with floodplain restoration potential, and there is only one comparatively small patch of medium restoration potential, both medium and high potentials were considered as equal. The polygons were 'intersected' according to the grid lines, and then 'overlay analysis' was conducted to find the percentage of area with natural floodplain restoration for each cell. In the resulting map, key areas with higher potential for floodplain restoration can be seen both within and outside the city borders. As it is unclear what methodology was used to identify the potential, the weight of this criteria is moderate.

![Potential for Natural Floodplain Restoration (normalized data)](Inserted_images/Biodiversity/Natural%20floodplain%20restoration%20potential%20(normalized%20data).png)

***Zones of Protected Natural Areas***

Legal protection for natural areas is vital to limit human activity which may negatively influence biodiversity. However, establishing protected areas are often insufficient in preventing biodiversity loss. Therefore, the zones of protected natural areas are considered in this analysis but are given limited weight [@Hein_Cunha_deFrancisco_2024].

Zones of protection of natural areas examine the level of legal protection which large-scale specially protected natural areas have. The zoning data was taken from Agency for Nature and Landscape Conservation of the Czech Republic (AOPK ČR, 2025, AOPK ČR, 2025). The dataset shows that there are some areas along the stream with Zone III and Zone IV levels of protection. Zone IV indicates a landscape management zone with the least strict protection, allowing for broader human activity, but still focusing on the preservation of ecological value. Zone III is a natural buffer zone where traditional and sustainable land use is still generally allowed. The map shows that mostly only the areas outside of the city borders have some level of protection.

To process the data, the polygons were 'intercepted' based on the grid lines, then the 'overlap analysis' function calculated the percentage of area different protection zones took up in each grid cell. Using the field calculator, the majority (>50%) value in each cell size was identified and normalized. In case there was no majority, the average between two values with the highest percentage of area was taken. For example, if a cell was 45% zone III and 35% zone IV, then the final cell value is 0.5, because zone VI has the normalized value of 0.25 and zone III has the normalized value of 0.75.

![Zones of Protected Natural Areas (normalized data)](Inserted_images/Biodiversity/Zones%20of%20protected%20natural%20areas%20(normalized%20data).png)

#### Biodiversity S-MCDA Aggregation & Conclusion

### 3.B. Climate Adaptation

! introduction

The climate adaptation chapter aims to follow the following sub-question:

> *Where along the stream can flood mitigation measures take place?*

This question is further divided into the following questions:

> *Which Areas Have Highest Flood Damage Risk?*

> *Which Areas Have The Most Impervious Surfaces?*

> *Which Areas Have Healthy Vegetation?*

![Aggregated Climate Adaptation Criteria](Inserted_images/General%20Images/Aggregated%20Climate%20Adaptation%20Criteria-01.png)

#### Which Areas Have Highest Flood Damage Risk?

! introduction

***Flood Impact Zones in Floodplains***

Floodplain are flat, low-lying areas near a river or coast that are likely to flood due to rainfall, tidal surges or other storm events. The type of landscaping in a floodplain can also reflect the level of flood risk.So we chose the following ranges when normalizing.

*Normalized Flood risk Table*

::: {.callout-note collapse="true"}
| Indicator | Low Flood Risk (0) | Middle Flood Risk (0.5) | High Flood Risk (1) | Normalized Range (0-1) |
|---------------|---------------|---------------|---------------|---------------|
| Landscape Type | Natural forest / wetland | Arable land / grassland | Built-up / paved surfaces | 0 – 1 |
:::

![Floodplain](Inserted_images/Climate%20Adaptation/floodplain%20map-01.png)

#### Which Areas Have The Most Impervious Surfaces?

! introduction

***Impervious Surface Percentage***

Impervious surfaces prevent water infiltration and increase runoff and heat accumulation. High imperviousness is typically associated with poor ecological performance and higher flood/heat risks. For this reason we chose to following ranges when normalizing.

::: {.callout-note collapse="true"}
*Normalized Impervious Table*

| Indicator | Low Risk Threshold (0) | High Risk Threshold (1) | Normalized Range (0–1) | Notes |
|---------------|---------------|---------------|---------------|---------------|
| Impervious Surface (%) | 0% | 80% | 0 – 1 | \>80% often found in dense urban areas, 0% = natural cover. Therefore we normalise between this range. |
:::

![Impervious_norm](Inserted_images/Climate%20Adaptation/Normalised_Mean_NDVI.png)

***Mean Night-Time Land Surface Temperature (LST)***

High night-time temperatures indicate poor cooling and urban heat retention. The LST was collected from the Terra & Aqua satellite from NASA. The temporal range of when the data collected was the average LST from the summer of 2022 (june to august), this range was taken due to data availability. This data was chosen as the resolution was the highest at 1 by 1 km. Risk increases with rising LST, especially during summer heatwaves. The following table below shows the range of data collected compared to the normalized range.

::: {.callout-note collapse="true"}
*Normalized Mean LST table*

| Indicator | Low Risk Threshold (0) | High Risk Threshold (1) | Normalized Range (0–1) | Notes |
|---------------|---------------|---------------|---------------|---------------|
| Mean Night-Time LST (°C) | 11°C | 16°C | 0 – 1 | 30°C = common threshold for urban heat stress at night, we chose to normalise for our range. Given Jablonec is at altitude, the temperature is going to be lower. |
:::

![LST_norm](Inserted_images/Climate%20Adaptation/Normalised_Mean_LST.png) \##### NDVI (Normalized Difference Vegetation Index)

#### Which Areas Have Healthy Vegetation?

! introduction

***Normalized Difference Vegetation Index (NDVI)***

NDVI indicates vegetation health and coverage. The NDVI was collected from the Sentinel-2 satellite using bands 2, 3 and 8. Then the mean NDVI was computed based on a temporal range of the last 5 years(between 01-01-2020 and 01-01-2025), the resolution of final NDVI is 10 by 10m. Higher values correspond to greener, more vegetated areas, contributing to cooling and ecosystem benefits. An NDVI of \>0.6 is typical of healthy vegetation in temperate zones [@ozyavuz2015determination]. For this reason the following table shows our justified choice of NDVI range when normalizing.

::: {.callout-note collapse="true"}
*Normalized NDVI Table*

| Indicator | Low Risk Threshold (0) | High Risk Threshold (1) | Normalized Range (0–1) | Notes |
|---------------|---------------|---------------|---------------|---------------|
| NDVI | 0.6 | 0.0 | 0 – 1 (inverted) | Values \>0.6 = dense vegetation; 0 = bare soil or built-up |
:::

![NDVI_norm](Inserted_images/Climate%20Adaptation/Bila%20Nisa%20(A3%20map)%20impervious.png)

#### Climate Adaptation S-MCDA Aggregation & Conclusion

### 3.C. Quality of life

For quality of life, can vary from psychological and health indicators to more tangible urban climate indicator. According to František Murgaš & Michal Klobučník [@Murgaš&Klobučník2016], they used the so-called gold standard for assessing quality of life in municipalities in the Czech Republic. The following indicators are included in the Gold standard for measuring the quality of life in urban environments. - Wanting to live—can be expressed by the absence of the will to live, i.e., suicide. Expression of the indicator is suicide mortality rate. - Long life—can be expressed by the indicator of life expectancy. - Living in a complete family—can be expressed by its absence; indicator is divorce rate. - Having children—can be expressed by the indicator of birth rate. - Being healthy—can be expressed by the absence of health; indicator is mortality. - Living in a healthy environment—can be expressed by the environmental pollution. - Being educated—can be expressed by the indicator of the share of university graduates. - Having a job—can be expressed by the indicator of unemployment rate. - Being a good person—can be expressed by the indicator of generativity.

Since many data are statistical data that have not been translated to vector layers, different indicators have been created which could give an idea of the quality of life. Koi and Masanobu [@Koi2008] discovered that accessiblity to basic human needs is an important factor for improving quality of life through policy implementation and spatial planning for land use purposes or transportation infrastructure. Moreover, Khalil [@Khalil2012] pointed out that economic viability of urban areas and the various of economic activity forms also an important indicator for quality of life and the functioning of urban systems.

Based on these 3 research papers, three different perspectives for measuring quality of life surrounding the area of the Bila Nisa urban stream have been picked; amenities around the stream, accessiblity of the stream, and the condition of the urban climate. Based on the assingment to enhance the quality of life along the stream, one main research question and three sub research questions have been drafted to pin point the areas along the Bila Nisa that underperform and require an intervention that enhances the quality of life along the urban stream according to the directions of the ReBioClim program.

> *Which areas along the stream need improvements for quality of life to address stakeholder conflicts?*

This question is further divided into the following questions:

> *Which Areas Are Deprived of Public Facilities?*

> *Which Areas Lack Infrastructure to Access?*

> *Which Areas Can Be Physically Uncomfortable?*

![Aggregated Quality of Life Criteria](Inserted_images/General%20Images/Aggregated%20Quality%20of%20Life%20Criteria-01.png)

For the first analysis, we look at the availability of public amenities such as green spaces and public goods that are available to the population along the Bila Nisa, that could support urban life and enhance quality of life. The Bila Nisa is known for its offering of leisure activities and greenery, however these areas are not connected, thus for a larger population perceived as inaccessible.

#### Which Areas Are Deprived of Public Facilities?

For the availability of public amenities along the stream, we looked at the availability of public green and the presence and diversity of public areas.

***Access to Public Green Space***

Apart from essential public amenities, the accessiblity of nature and public green offer comfort in urban areas and is an important factor to be taken into account. As stated in the case, ecological quality of the stream has been degregated through human activity, which also impacts the quality of life in the proximity of the stream. However, along the borders of the urban area, patches of green over access to public green.

![Map showing public green along Bila Nisa stream](Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20public%20green%20along%20stream%20data%20input.png) The area of public green is then further normalized, through the following formula, thus normalizng the area on a scale from 0 to 1.

::: {.callout-note collapse="true"}
**Normalized value** = *("area mean" - min("area mean")) / (max("area mean") - min("area mean"))*
:::

::: {.callout-note collapse="true"}
*Normalized Public Green Table*

| Variable | Low availability (0-0.2) | High availability (0.8-1) | Notes |
|------------------|------------------|------------------|------------------|
| Area mean | \<10073,8 | \>40295,2 | \<10073,8 → 0-0.2 (low availability), \>40295,2 → 0.8-1 (high availability) |
:::

![Normalized map of public green availability along Bila Nisa](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20public%20green%20along%20stream%20normalized.png)

***Access to Public Amenities***

![Public amenities along Bila Nisa stream](Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Public%20amenities%20data%20input.png) [@PoIOSM]

Based on these public amenities, data is normalized based on the diversity of public amenities and the size of the public areas, which indicates to what extent the area can be used by the population of Jablonec.

First, the public amenities are clipped within the grid of the Bila Nisa stream. The clipped layer is overlayed in the grid creating a separate layer. The data is then normalized through adding a separate column, where the range of area and functions is used through the following functions. Using this formula, data is normalized to a 0 to 1 scale.

::: {.callout-note collapse="true"}
**Normalized value** = *("type count" - min("type count")) / (max("type count") - min("type count"))*
:::

::: {.callout-note collapse="true"}
*Normalized Public Amenities Table*

| Variable | Low availability (0-0.2) | High availability (0.8-1) | Notes |
|------------------|------------------|------------------|------------------|
| Type count | \<2 | \>5 | \<2 → 0-0.2 (low availability), \>5 → 0.8-1 (high availability) |
:::

![Normalized map size of public amenities](Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Size%20of%20public%20areas%20normalized.png) ![Diversity of public amenities along Bila Nisa](Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Diversity%20public%20areas%20normalized.png)

Combining these two layers using the criteria weights in the S-MCDA, two areas stand out due to the combination of public greenery and the diversity of amenities. ![Combined normalized layers of public goods availability](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/AVAILABILITY%20PUBLIC%20GOODS.png)

#### Which Areas Lack Infrastructure to Access?

The second indicator for quality of life is the accessibility of the stream. The stream offers apart from a livable climate due to the cooling effect of the river also a social haven for the population of Jablonec nad Nisau, offering several meeting spots in the leisure areas along the stream. For this analysis, accessiblity through the road network and public transport infrastructure is measured using the following two layers.

***Access to Stream***

Apart from access to essential human needs along the stream, the Bila Nisa itself is a potential area where people can visit to get in touch with nature and a more comfortable urban environment, taken into account that the urban environment will be impacted further through the effect of climate change. Accessiblity to the stream is therefore an important indicator for quality of life. First, access to the Bila Nisa is analyzed through the road network of Jablonec nad Nisau. A space syntax is used to determine which roads are better integrated to the road network which determines which part of the stream are more centralized and better accessible.

![Angular integration of road network indicating local centers](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20to%20stream%20data%20input.png) [@RoadsOSM]

The roads that fall within reach of the stream are clipped and used for further normalization. The clip is overlayed in the grid, and both the number of roads and degree if integration with the road network are taken into account in the normalization. Using the open field calculator, a new column is created for normalizing the data of the layer using the following formula:

::: {.callout_note collapse="true"}
**Normalized value** = *("sum_Atw2kM" - minimum("sum_Atw2kM")) / (maximum("sum_Atw2kM") - minimum("sum_Atw2kM"))*
:::

Categorizing the layer with the newly calculated normalized column, the following map shows how urban centers North, central and South-west of the stream can be defined.

::: {.callout-note collapse="true"}
*Normalized Road Integration Table*

| Variable | Low Integration(0) | High Integration (1) | Notes |
|------------------|------------------|------------------|------------------|
| Angular Integration Sum 2k | \<41.25 | \>115.25 | \<41.25 → 0-0.25 (low integration), \>115.25 → 0.75-1 (high integration) |
:::

![Nominal map showing accessiblity to urban centers](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20to%20stream%20normalized.png)

***Access to Public Transport***

Apart from the road network, which primarily focusses on private mobility, public transport offers a good indication how the stream can be accessed from a more regional point of view. For this, a data layer from the ArcGIS web [@publictransportJablonecnadNisau] is found that represents the public transport network of Jablonec nad Nisau. A clip from this layer is made, which results in a couple of bus stops and a tram stops that fall within reach of the stream. To see how accessible the stream is from public transportation, service areas are used with a radius of 500m (bus stops) and 1000m (tram stops) based on the type of connection. Bus is more urban while the tram has a regional connection with the neighboring city of Liberec.

![public transport access within stream area](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20public%20transport%20near%20stream%20data%20input.png) Based on the number of opportunities, which is based on how many service areas overlap, the data can be normalized. A separate column is created that calculates the data using a normalized scale from 0 to 1, using the range of opportunities. [@publictransportJablonecnadNisau]

::: {.callout-note collapse="true"}
**Normalized value** = *("layer count" - min("layer count")) / (max("layer count") - min("layer count"))*
:::

::: {.callout-note collapse="true"}
*Normalized Public transport proximity Table*

| Variable | Low Access(0) | High Access (1) | Notes |
|------------------|------------------|------------------|------------------|
| Layer Count | =0 | \>4 | \<1 → 0-0.2 (low access), \>4 → 1 (high access) |
:::

![Access to public transport near the stream normalilzed](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20public%20transport%20along%20stream%20normalized.png)Overlaying these two layers, one can see a couple urban centers popping up. Especially in the south which is a more urban area and offer different modes of transport and regional connections. Furthermore, there is one main road along the stream connecting the city of Jablonec nad Nisau with rural villages like Loucná nad Nisau. However, the map shows that more central areas with leisure are not well connected.

![Combined accessibility map](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/ACCESSIBLITY%20TO%20STREAM.png)

#### Which Areas Can Be Physically Uncomfortable?

The last performance indicator for quality of life relates to physical condition of the urban environment, in other words to figure out how healthy the urban environment around the Bila Nisa is. This is relevant for the case of Jablonec nad Nisau since the area was once a breeding ground for industrial activity, especially for glass and glass ornament production [@Brittanica2011].

***Air Pollution***

To ensure comparability across pollutants, all air quality indicators were normalized to a common scale between 0 and 1. The normalization is based on internationally recognized health guidelines from the World Health Organization [@who2021] and the European Union (Directive 2008/50/EC) [@eu_air_quality]. For PM₁₀, PM₂.₅, and NO₂, thresholds were defined using three reference points: half the WHO annual guideline value (representing minimal health risk), the WHO annual guideline value (health-based target), and the EU legal limit (regulatory maximum). For SO₂, BaP, and BzN, thresholds were determined using available EU targets or inspired by the Belgian national limits [@irceline2022]. All values were normalized using the upper bound of each category range to reflect worst case exposure levels for each grid cell. This approach allows consistent interpretation of long-term exposure risks across pollutants.

::: {.callout-note collapse="true"}
*Normalized Pollution table*

| Pollutant | WHO 2021 Guideline (µg/m³) | EU Limit (µg/m³) | Low Risk Threshold (0) = ½ WHO | High Risk Threshold (1) = EU | Normalized Range (0–1) |
|------------|------------|------------|------------|------------|------------|
| PM2.5 | 5 | 20 | 2.5 | 20 | 0 – 1 |
| PM10 | 15 | 40 | 7.5 | 40 | 0 – 1 |
| NO₂ | 10 | 40 | 5 | 40 | 0 – 1 |
| BaP | *0.12 (indicative, EU)* | 1.0 | 0.06 | 1.0 | 0 – 1 |
| BzN | 0.2 *(WHO guideline)* | 1.0 *(assumed)* | 0.1 | 1.0 | 0 – 1 |
| SO₂ | 40 *(WHO 24h guideline)* | 125 *(EU 24h)* | 20 | 125 | 0 – 1 |
:::

A then example calculation in Qgis for SO2 would be:

::: {.callout-note collapse="true"}
*Example calculation for SO2*

CASE WHEN "MAX_majority" IS NULL THEN NULL WHEN "MAX_majority" \< 20 THEN 0 WHEN "MAX_majority" \> 125 THEN 1 ELSE ("MAX_majority" - 20) / (125 - 20) END
:::

However, as was later discovered, this approach led to all of the pollution data being qualified as 0. Given the Czech data is categorized differently and is given as aggregated annual values, a choice was made to use the same range given with the data (and its associated colours) when normalizing. Given that our analysis is context specific, changing the normalization will highlight the range in air quality within our given site. Whether the air quality is below or above the recommended values will no longer become the basis.

This simpler method yields the final table with the new normalization based on the input data classification is the following.

::: {.callout-note collapse="true"}
*New Normalized Pollution Table*

| Pollutant | Observed Max (From Layer) | Low Risk Threshold (0) | High Risk Threshold (1) | Normalization Formula |
|---------------|---------------|---------------|---------------|---------------|
| PM2.5 | 2.5 | 0 | 5 | `"MAX_max" / 2.5` |
| SO₂ | 2.5 | 0 | 5 | `"MAX_max" / 2.5` |
| BaP | 0.16 | 0 | 0.16 | `"MAX_max" / 0.16` |
| PM10 | 3 | 0 | 3 | `"MAX_max" / 3` |
| NO₂ | 3.5 | 0 | 3.5 | `"MAX_max" / 3.5` |
| BzN | 0.25 | 0 | 0.25 | `"MAX_max" / 0.25` |
:::

***Percentage of Tree Cover***

Tree cover density represents the percentage of land surface covered by trees within our chosen area of interest. This measure is normalized on a 0 to 1 scale, where 0 corresponds to \<25% tree cover and 1 corresponds to \>75% tree cover. This range was chose as lower tree cover densities (\<0.25) are linked to increased land surface temperatures and higher urban heat island effects, while higher densities (\>0.75) are associated with reduced temperatures and mitigation of urban heat [@morabito2021surface].

::: {.callout-note collapse="true"}
*Normalized Tree Cover Table*

| Variable | Low Risk Threshold(0) | High Risk Threshold (1) | Notes |
|------------------|------------------|------------------|------------------|
| Tree Canopy Cover | \>75% | \<25% | 75% → 0 (low risk), 25% → 1 (high risk) |
:::

```{r}
#| echo: false
#| warning: false
#| message: false
library(slickR)


imgs <- c("Inserted_images/Biodiversity/Normalised_mean_Treecover.png", "Inserted_images/Biodiversity/Mean_treecover.png")

slickR(imgs, height = 800, width = 600) +
  settings(dots = TRUE)

```

Combining these two layers results in the following combined map. The map shows the more urban one goes, the less liveable the urban climate becomes. Some areas score low because they are former and current industrial areas, for example H

![Urban life conditions along the Stream](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/URBAN%20LIFE%20CONDITIONS.png)

#### Quality of Life S-MCDA Aggregation & Conclusion

Using the criteria of the S-MCDA analysis, a combined map is created to highlight which areas along the Bila Nisa stream perform less on quality of life, and suggest an intervention is required to enhance quality of life performance along the urban stream.

All the normalized data is extracted from the attribute table and transferred to an Excel file to calculate the normalized values against the criteria weights from the S-MCDA. All the weighted values are combine in order to create and prepare the aggregated data set for quality of life. Only for the criteria air pollution, the data is inverted as a higher score, means higher the air pollution, which is a negative indicator for urban life condition. The data is then exported as a CSV file in QGIS and the aggregated values are joined in the combined grid layer. The final combined map is presented underneath.

![Combined and weighted quality of life map](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Bila%20Nisa%20Jablonec%20-%20Combined%20Quality%20of%20Life.png)

### 3.D. S-MCDA Conclusion

Short recap, key findings, recommendations

![Concluding S-MCDA Maps](Inserted_images/Concluding%20S-MCDA-01.png)

## 4. Typology Construction

Our approach to out topology construction is embedded in our main reserach questions and goals. Based on our analysis we formulated the following guiding question for finding relevant typologies in Jablonec nad Nisou.

### 4.a. Research Question & Variables

*"What spatial typologies emerge from key ecological and accessibility indicators along the stream corridor, and how can they inform targeted green-blue infrastructure interventions?"*

This question is grounded in the broader ambition to enhance ecosystem services, urban climate resilience, and quality of life through the strategic planning of nature-based solutions. To approach this, we identified from all of our indicators, 4 main key spatial indicators that reflect the multifunctionality of green-blue spaces. Each indicator was selected to represent a dimension of performance relevant to our project:

**Proportion of Natural Habitat (Biodiversity):** A higher share of natural habitat suggests greater ecological quality and potential for species support and connectivity.

**Normalized Difference Vegetation Index (NDVI) (Climate Adaptation)**: NDVI serves as a proxy for vegetative health and biomass, contributing to climate regulation, shading, and evapotranspiration.

**Flood Impact Zones in Floodplains (Climate Adaptation):** Areas exposed to flood risk offer opportunities for flood-resilient design, such as for example wetland restoration or floodable parks.

**Access to Stream (Quality of Life):** Stream accessibility reflects the potential for recreation, well-being, and nature connection for residents, which at the moment due to stakeholder conflicts may be lacking.

By combining these indicators, we aim to capture both the ecological aspects and human functionality of areas along the stream. This will enable us to cluster similar grid cells into meaningful typologies relevant to our research. We believe that the typologies will support decision making for where to preserver, intervene or enhance the multifunctional green-blue spaces along the Bila Nisa stream.

### 4.b. Methodology

To begin our typology construction, we chose to perform K-means clustering. The following section will guide you through the process we took to reach the typologies.

The first step of conducting K-means clustering involves standardizing our normalized input data.

We use the **elbow method** to choose a good number of clusters.

For each value of `k` (e.g. 2 to 9), we run K-means and record a value called **inertia** : the total distance between points and their cluster centers. Lower inertia means tighter (better) clusters.

```{r echo=FALSE, warning=FALSE, message=FALSE}

#install.packages("sf") 
#install.packages("dplyr")
#install.packages("plotly")
#install.packages("cluster")


library(sf) # for processing vector data 
library(dplyr) # for selecting and transforming data
library(plotly)
library(cluster)
library(ggplot2)


#getwd()
grids <- st_read("inserted_images/final_output_geopackages/TOPOLOGY_FINAL_ATTRIBUTES.gpkg", quiet = TRUE)

# View the first few rows of the data
#head(grids)

##########################################################
#Choose the insert Layers
##########################################################

# Plot impervious
plot(grids["ROZ_unique"], border = NA, main = "Flood Impact Zones in Floodplains")

# Plot slope
plot(grids["NDVI_norm"], border = NA, main = "NDVI")

# Plot crossing
plot(grids["AccesstoStream_norm"],  border = NA, 
     #breaks = "quantile", 
     main = "Access to Stream")

plot(grids["Percentage_habitat_n"], border = NA, main = "Proportion of Natural Habitat")

##########################################################
#Scale the Insert Layers
##########################################################

features <- grids |> 
  select(ROZ_unique, NDVI_norm, AccesstoStream_norm, Percentage_habitat_n) |>
  st_drop_geometry() # remove geometry column so we just keep a data table

X_scaled <- scale(features) # Standardize (mean=0, sd=1) 

#head(X_scaled)

##########################################################
#Calculate Inertia and Elbow
##########################################################


# Initialize an empty numeric vector to store inertia values 
inertia <- numeric()

# Try k values from 2 to 9
k_values <- 2:9

# Loop through each k value (here we can also add silhouette)
for (k in k_values) {
  km <- kmeans(X_scaled, centers = k, nstart = 50) 
  
  # tot.withinss is Total within-cluster sum of squares
  # This measures how compact the clusters are: lower is better.
  inertia <- c(inertia, km$tot.withinss)
}

# Combine the results into a data frame for plotting
elbow_df <- data.frame(k = k_values, inertia = inertia)

#print(elbow_df)

```

::: callout-note
We suggest using a larger `nstart` value, such as 20 or 50, to get more reliable results. Setting `nstart = 20` makes R try 20 different starting points and choose the one with the lowest `tot.withinss`. The `tot.withinss` value measures how close points are to their cluster centers. Lower values mean better clustering.
:::

We can visualize how inertia changes with increasing k. After a certain point, adding more clusters doesn’t help much — the curve bends. That bend is called the *elbow point*, and we use it to choose the best k.

```{r echo=FALSE, warning=FALSE, message=FALSE}
##########################################################
# Plot the elbow -> we will choose 5 clusters
##########################################################

# Make the elbow plot
plot(k_values, inertia,
     type = "b",                  # shown both points + lines 
     col = "darkblue",
     main = "Elbow Method")


```

Based on the elbow plot, we choose `k = 5` as a good number of clusters.\
We now run the K-means algorithm and assign each grid to one of the five clusters. The following shows us the clusters formed along the Bila Nisa stream.

```{r echo=FALSE, warning=FALSE, message=FALSE}

##########################################################
# Run the K means Clustering
##########################################################

# `set.seed()` sets the random number generator to a fixed state
# Set the seed so the clustering result is always the same when re-run
set.seed(0)  # The number 0 is just a fixed choice. You can also use 10, 345, etc.

# Choose the number of clusters based on the elbow plot
k <- 5
kmeans_result <- kmeans(X_scaled, centers = k, nstart = 20)
grids$cluster <- as.factor(kmeans_result$cluster) # The result kmeans_result$cluster is a list of cluster labels (1 to 4), in the same order as the original rows in X_scaled and grids

#head(grids)

# Show how many grids fall into each cluster
#print(table(grids$cluster))

##########################################################
# Run the K means Clustering
##########################################################

library(RColorBrewer)

# Choose a palette and number of clusters
k <- length(unique(grids$cluster))  
my_colors <- brewer.pal(n = k, name = "Spectral") 

# Assign colors to clusters
cluster_colors <- my_colors
names(cluster_colors) <- as.character(1:k)

# Create color vector for plotting
plot_colors <- cluster_colors[as.character(as.numeric(grids$cluster))]

# Plot using base R
plot(st_geometry(grids), 
     col = plot_colors,
     main = "Spatial Pattern of Urban Stream Clusters", 
     border = NA)

# Add legend
legend("topright", 
       legend = paste("Cluster", names(cluster_colors)), 
       fill = cluster_colors, 
       title = "Clusters",
       bty = "n",
       cex = 0.8)
```

To be able the visualize the distribution of the 5 clusters in 3D space, the following plot was created. As we have 4 indicators, and we cannot easily visualize the 4 dimensional representation of our clustering. When deciding on which indicators to use for the axis, we inspected all possible options and chose the most appealing visual representation which spatially distributed the clusters the best.

```{r echo=FALSE, warning=FALSE, message=FALSE}

##########################################################
# Visualise the 3d plot of the Kmeans cluster
##########################################################

# For 3D plotly

features$cluster <- grids$cluster
features$color <- cluster_colors[as.character(features$cluster)]

features$color <- cluster_colors[as.character(features$cluster)]

plot_ly(
  data = features,
  x = ~Percentage_habitat_n,
  y = ~NDVI_norm,
  z = ~AccesstoStream_norm,
  color = ~cluster,
  colors = cluster_colors,
  type = "scatter3d",
  mode = "markers",
  marker = list(size = 3)
) %>%
  layout(
    title = "3D Cluster Plot: Green-Blue Functionality Typology",
    scene = list(
      xaxis = list(title = "Proportion of Natural Habitat"),
      yaxis = list(title = "NDVI (Greenness)"),
      zaxis = list(title = "Access to Stream")
    )
  )
```

Therefore, to ensure another representation of each cluster in respect to their indicator we can plot Polar charts. This can help visualise the 4 dimensional nature and what typological counterpart each cluster would represent. Based from these charts we can assign each cluster a correct typology.

```{r echo=FALSE, warning=FALSE, message=FALSE}

##########################################################
# Create Radar Charts for the 5 Typologies
##########################################################

# Install and load necessary packages
if (!require("fmsb")) install.packages("fmsb")
library(fmsb)

# Get the cluster centers (in standardized form)
scaled_centers <- kmeans_result$centers

# Print them
#print("Cluster centers (standardized):")
#print(scaled_centers)

# Convert the centers back to original scale: x * SD + mean
original_centers <- t(apply(
  scaled_centers, 1, 
  function(x) x * attr(X_scaled, "scaled:scale") + attr(X_scaled, "scaled:center")
))

# Print the real-world values
#print("Cluster centers (original):")
#print(original_centers)


# Get the cluster center for each row, using the cluster assignment
centroids_matrix <- kmeans_result$centers[kmeans_result$cluster, ]

# Calculate Euclidean distance between each point and its assigned cluster center
grid_distances <- sqrt(rowSums((X_scaled - centroids_matrix)^2))

# Save to grids
grids$cluster_dist <- grid_distances


# Prepare the data for radar chart
radar_data <- as.data.frame(original_centers)

# Add column names (simplified without spaces to avoid issues)
colnames(radar_data) <- c("Flood_Zone", "NDVI", "Stream_Access", "Natural_Habitat")

# To use fmsb, we need to add max and min of each variable to the dataframe
max_min <- data.frame(
  Flood_Zone = c(max(radar_data$Flood_Zone), min(radar_data$Flood_Zone)),
  NDVI = c(max(radar_data$NDVI), min(radar_data$NDVI)),
  Stream_Access = c(max(radar_data$Stream_Access), min(radar_data$Stream_Access)),
  Natural_Habitat = c(max(radar_data$Natural_Habitat), min(radar_data$Natural_Habitat))
)

rownames(max_min) <- c("Max", "Min")

# Combine the max_min with the data
radar_data <- rbind(max_min, radar_data)

# Set colors for each cluster
colors_radar <- cluster_colors


# Set graphic parameters
op <- par(mar = c(2, 2, 4, 2),  # Bottom, Left, Top, Right margins
          cex.main = 1.5)        # Larger title font size

# Create the radar chart
radarchart(
  radar_data,
  axistype = 1,
  seg = 3,
  title = "All Clusters Comparison",
  pcol = colors_radar,
  plwd = 2,
  plty = 1,
  cglcol = "grey",
  cglty = 1,
  axislabcol = "grey",
  caxislabels = seq(min(radar_data[2,]), max(radar_data[1,]), length.out = 4),
  cglwd = 0.8,
  vlcex = 1, 
  calcex = 0.5
)


legend(
  "topright",
  legend = paste("Cluster", 1:k),
  bty = "n",
  pch = 20,
  col = colors_radar,
  text.col = "black",
  cex = 1,  
  pt.cex = 2
)

# Reset graphical parameters
par(op)

```

### 4.c. Results

**Interpreting the cluster centers**

Now we look at the center of each cluster. First, we check the values in standardized form. Then, we convert them back to the original units (e.g. degrees), so they are easier to understand. Then, to interpret the clustering results, we examine the centers of each cluster in the original data scale. The table below summarizes the environmental characteristics of each cluster based on the original (unscaled) values. From these we can assign our created typology description, testing if they align with our initial set out goals and conjectures.

Additionally, it is also clear that each grid cell will not be as representational of it's typology. This can be visualised depending on it;s distance to the cluster center. This shows us a clearer picture of the distribution of points around their centers, identifying the spread of each cluster. This is helpful when determining the typologies which are most related. Histograms of each Cluster around their respective centers is shown below.

```{r echo=FALSE, warning=FALSE, message=FALSE}

##########################################################
# Compute distance to cluster center
##########################################################


# Histogram with density curve
ggplot(grids, aes(x = cluster_dist, fill = cluster)) +
  geom_histogram(alpha = 0.6, bins = 30, position = "identity") +
  facet_wrap(~cluster) +
  scale_fill_manual(values = cluster_colors) +
  theme_minimal() +
  labs(
    title = "Distance to Cluster Centers by Cluster",
    x = "Euclidean Distance (standardized feature space)",
    y = "Count"
  )

st_write(grids, "data/clustered_tiles_with_distances.gpkg", delete_dsn = TRUE)

#print(grid_distances)
```

![Distance to each cluster center for each respective cluster](Inserted_images/distance_to_cluster_center.png)

**Typology description**

Based on this we have assigned the following descriptions to each typology and our analysis we are able to descript each cluster as a typology. We have therefore come up with the following descriptions.

::: {style="font-size: 0.85em"}
| Type (Cluster) | Natural Habitat | NDVI | Flood Zone | Stream Access | Description |
|------------|------------|------------|------------|------------|------------|
| 1 (Red) | **High** | **High** | Low | Low | This cluster represents areas with lush, **biodiverse vegetation and high ecological quality.** These zones have low flood risk but are relatively inaccessible to the public. Their primary value lies in their ecological function.​ |
| 2 (Orange) | Low | Moderate | Moderate | **High** | High-access area with limited vegetation or habitat. Here there is potential for **urban greening or recreational upgrades.** Their moderate flood risk indicates a need for **climate adaptation strategies.**​ |
| 3 (Yellow) | Low | Low | Moderate | Low | This typology consists of degraded areas with limited vegetation, biodiversity, and accessibility. This is suitable for **buffer zones or low-impact enhancement.**​ |
| 4 (Green) | **High** | Low | Low | Low | Although these areas are classified as having **high natural habitat**, they exhibit **low vegetation health or cover**. Stream access is also limited. This could indicate sparse but valuable habitats.​ |
| 5 (Blue) | **High** | Low | **High** | Low | Flood-exposed, degraded zone. Here we can prioritize **wetland restoration or flood-resilient interventions.**​ |
:::

**Identifying where the clusters are located and which are closest to their cluster centers**

```{r}
#| echo: false
#| warning: false
#| message: false
library(slickR)


imgs <- c("Inserted_images/Cluster_Maps/Distance_to_cluster_center.png",
          "Inserted_images/Cluster_Maps/top5_gridcells.png")

slickR(imgs, height = 800, width = 500) +
  settings(dots = TRUE, autoplay = TRUE, infinite = TRUE)

```

**Visualizing the Five Grid Cells Closest to their cluster centers**

In the maps below, we visualize each cluster and its grid cell which is closest to the center of its cluster.

```{r}
#| warning: false
#| echo: false
#| message: false

library(htmltools)

imgs <- c("Inserted_images/Cluster_Maps/Cluster_1.png",
          "Inserted_images/Cluster_Maps/Cluster_2.png",
          "Inserted_images/Cluster_Maps/Cluster_3.png",
          "Inserted_images/Cluster_Maps/Cluster_4.png",
          "Inserted_images/Cluster_Maps/Cluster_5.png")

# Create a grid of images with onclick fullscreen support
image_grid <- div(
  style = "display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;",
  lapply(imgs, function(img) {
    tags$img(
      src = img,
      style = "max-width: 18%; cursor: pointer; border: 1px solid #ccc; border-radius: 8px;",
      onclick = sprintf("openFullscreen(this)")
    )
  })
)

# Add fullscreen JavaScript function
fullscreen_script <- tags$script(HTML("
  function openFullscreen(el) {
    if (el.requestFullscreen) {
      el.requestFullscreen();
    } else if (el.webkitRequestFullscreen) { /* Safari */
      el.webkitRequestFullscreen();
    } else if (el.msRequestFullscreen) { /* IE11 */
      el.msRequestFullscreen();
    }
  }
"))

# Render all together
browsable(tagList(image_grid, fullscreen_script))


```

## 5. Discussion

The chosen methods conducted data analysis and normalization tried to account for the difference in grid cell size by weighing values based on cell size and choosing analysis methods which are not size-dependent (such as percentage of cover area). However...

### Impact of Scale on Detectable Effects

The spatial resolution of the data we collected significantly shapes the analytical results. Averaging the data collected within the chosen 100 x 100m and 50x50m cells allows for generalized insights, which we found best fitting. It may however still obscure localized effects such as even smaller micro climatic benefits of tree clusters or linear vegetation elements. We chose the trade off that best fits our and balances detail with analytical feasibility.

-   mention how the grid cell size may/may not affect the results;
-   discuss abt value of this data for analysis and decision-making;
-   discussion: data availability, buffer size;
-   grid size and positioning impact on results

### Group Reflection

## 6. Conclusion

## 7. Appendix

```{r}
#| warning: false
#| echo: false
#| message: false

library(htmltools)

imgs <- c(
  "Inserted_images/Biodiversity/Floodplain%20biotope%20value%20(original%20data).png",
  "Inserted_images/Biodiversity/Diversity%20of%20natural%20habitats%20(original%20data).png",
  "Inserted_images/Biodiversity/Natural%20habitats%20-%20cover%20area%20(original%20data).png",
  "Inserted_images/Biodiversity/Weighed%20road%20segment%20lenght%20(original%20data).png",
  "Inserted_images/Biodiversity/Built-up%20area%20(original%20data).png",
  "Inserted_images/Biodiversity/Ecological%20corridors%20(original%20data).png",
  "Inserted_images/Biodiversity/Natural%20floodplain%20restoration%20potential%20(original%20data).png",
  "Inserted_images/Biodiversity/Zones%20of%20protected%20natural%20areas%20(original%20data).png",
  "http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20public%20green%20along%20stream%20data%20input.png)",
  "http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20public%20transport%20near%20stream%20data%20input.png",
  "http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Access%20to%20stream%20data%20input.png",
  "http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/Inserted_images/Quality%20of%20Life/Bila%20Nisa%20Jablonec%20-%20Public%20amenities%20data%20input.png"
)
  
titles <- c(
  "Floodplain biotope value (original data)",
  "Diversity of natural habitats (original data)",
  "Natural habitat cover area (original data)",
  "Weighted road segment length (original data)",
  "Built-up area (original data)",
  "Ecological corridors (original data)",
  "Floodplain restoration potential (original data)",
  "Protected natural zones (original data)",
  "Bila Nisa Jablonec - Access public green along stream data input",
  "Bila Nisa Jablonec - Access public transport near stream data input",
  "Bila Nisa Jablonec - Access to stream data input",
  "Bila Nisa Jablonec - Public amenities data input"
)

# Create a grid of images with titles and fullscreen support
image_grid <- div(
  style = "display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;",
  Map(function(img, title) {
    div(
      style = "max-width: 18%; text-align: center;",
      tags$img(
        src = img,
        style = "width: 100%; cursor: pointer; border: 1px solid #ccc; border-radius: 8px;",
        onclick = sprintf("openFullscreen(this)")
      ),
      tags$p(title, style = "font-size: 0.85em; margin-top: 6px;")
    )
  }, imgs, titles)
)

# Add fullscreen JavaScript function
fullscreen_script <- tags$script(HTML("
  function openFullscreen(el) {
    if (el.requestFullscreen) {
      el.requestFullscreen();
    } else if (el.webkitRequestFullscreen) { /* Safari */
      el.webkitRequestFullscreen();
    } else if (el.msRequestFullscreen) { /* IE11 */
      el.msRequestFullscreen();
    }
  }
"))

# Render everything
browsable(tagList(image_grid, fullscreen_script))


```
