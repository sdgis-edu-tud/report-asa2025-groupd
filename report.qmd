---
title: "Title of your report"
subtitle: "Project report of Group D"
author:
  - name: "Frederick Auer"
    affiliation: "MSc Geomatics"
    group_role: "Software/Program Helper & Data Collector"
  - name: "Lin Ruofan"
    affiliation: "MSc Landscape Architecture"
    group_role: "Mapping Specialist & Design Lead"
  - name: "Matthijs Jerez Nova"
    affiliation: "MSc Urbanism"
    group_role: "Writer/Editor & Research Lead"
  - name: "Ula Kunigelyte"
    affiliation: "MSc Urbanism"
    group_role: "Mapping Specialist & Data Analyst"
  - name: "Finn van Asch"
    affiliation: "MSc Urbanism"
    group_role: "Research Lead & Assistant Mapping Specialist"

bibliography: references.bib
csl: apa.csl

format: html

editor: visual
---

```{r}
#| label: setup


```

## Introduction

Urban areas across Europe are increasingly challenged by the impacts of climate change, biodiversity loss, and the demand for sustainable development [@nijkamp2013new]. According to [@article], in cities the impact of land use on fresh-water ecosystems is especially severe. As climate change is expected to increase the intensity and frequency of extreme weather events, solutions to combat these effects are urgently needed [@ourloglou2020assessing].

A good solution is through urban streams. Urban streams are expected to have an important role in the mitigation of climate change by buffering extreme temperatures and prevent floods. More importantly, finding nature-based solutions are key and can restore existing strained water systems [@ourloglou2020assessing]. In this context, spatial analytics can play a crucial role in informing climate adaptation and urban planning strategies [@hurlimann2012role]. Through methods such as Spatial Multi-Criteria Decision Analysis (S-MCDA) and typology development, planners and designers can better understand urban systems, evaluate trade-offs, and propose the correct targeted interventions.

The ReBioClim project, funded by the Interreg Central Europe Program [@rebioclim2024], exemplifies this approach by focusing on revitalizing small urban streams. It additionally provides a framework where nature-based solutions can be identified to enhance biodiversity, mitigate climate change effects, and improve urban living conditions [@rebioclim_ioer2024]. Running from June 2024 to January 2027, the project addresses the challenges of urban stream restoration in four Central European cities, including Jablonec nad Nisou, the case targeted in this report.

![ReBioClim Project Overview](Inserted_images/rebioclim_currentstate.png){width="600"}

Over recent decades, Jablonec nad Nisou has experienced overbuilding, channelization, and neglect of its urban streams, leading to ecological degradation and reduced quality of life. Our objective is to quantitatively assess the current state of these waterways and identify areas with the highest potential for improvement. Through these efforts, we aim to provide a better understanding of where and how to restore the waterways and create green-blue corridors that offer cooling effects, improve air quality, and provide recreational spaces for residents.

```{r fig.subcap="Jablonec nad Nisou and the Bila Nisa stream"}
#| warning: false
#| echo: false
#| message: false
library(leaflet)
library(sf)

# Read the stream GeoJSON without 
stream <- st_read("Inserted_images/stream_for_interactivemap.geojson", quiet = TRUE)

# Coordinates for Jablonec nad Nisou
jablonec_coords <- c(lat = 50.7224, lng = 15.1708)

# Render leaflet map
leaflet() %>%
  addTiles() %>%
  addPolylines(
    data = stream,
    color = "blue",
    weight = 3,
    opacity = 0.8,
    popup = "Bílá Nisa Stream"
  ) %>%
  addCircleMarkers(
    lng = jablonec_coords["lng"],
    lat = jablonec_coords["lat"],
    radius = 6,
    color = "red",
    fillOpacity = 0.8,
    label = "Jablonec nad Nisou"
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("blue", "red"),
    labels = c("Bílá Nisa Stream", "Jablonec nad Nisou"),
    title = "Legend",
    opacity = 0.8
  )
```

Our research centers on the Bílá Nisa stream, and will address the problems we have identified through the lens fo the three following goals: Biodiversity, Climate Adaptation, and Quality of Life. These goals, relevant to our location has led to our main research question:

> *Where should urban stream restoration be prioritized in Jablonec nad Nisou to maximize biodiversity, climate adaptation, and quality of life?*

Our derived subquestions, respective to each goal are then the following:

> *Where can the ecological quality of the stream area be enhanced?*

> *Which areas are the most in need for flood protection?Where can flood mitigation measures take place?*

> *Where can improvements in quality of life balance stakeholder interests in areas around the stream?*

//we will add how the report is structured here after.

## Methodology

A important foundation for applying spatial analytics in urban environments is in the careful definition of the area of interest (AOI) and the spatial units used for analysis. The decisions regarding spatial scale, unit configuration, and data resolution directly influences the insights that can be drawn from spatial data. [@dungan2002balanced] The justification of our area of interest and chosen spatial unit is structured around principles derived from literature, geographical context and data availability. Furthermore, in order to apply a S-MCDA normalized values at a comparable scale are needed, further emphasizing the importance of defining an appropriate spatial unit.

### Definition of Spatial Units

To conduct a meaningful spatial analysis, the study area must be divided into standardized spatial units. For example, urban heat island and green infrastructure studies have shown to use a regular grid of 50 x 50 meter cells as the base unit of analysis [@BARTESAGHIKOC2020103893]. On the other hand, [@burdziej2019using] uses a hexagonal grid where each hexagon has a side length of 100 m, selected based on the size of the study area (Toruń, Poland) and the intended spatial resolution of the study.

Therefore, based on the size of Jablonec nad Nisou and the Bila Nisa stream as well as the following discussed principles affecting the conducted analysis, a spatial unit grid of 100 x 100 meters was chosen. The unit is used for consistency in the assignment of spatial indicators and facilitates the aggregation and comparison of data across the urban stream landscape. The 100 x 100m spatial unit is specific to the scale Jablonec nad Nisou, the resolution of the data collected and relevant literature on stream assessments.

### Resolution and Data Acquisition Method

The resolution of spatial analysis is directly tied to the data acquisition method [@BARTESAGHIKOC2020103893]. While spaceborne remote sensing used for the measurement of some of our indicators when data availability was lacking is better suited for large-scale urban assessments, it often lacks the spatial precision needed for detailed micro climatic or ecological studies. On the other hand, biodiversity and quality of life data are generally acquired at larger scale and would require smaller spatial units. For example, the widely accepted walking range of 500 meters [@macioszek2022effect; @popp2004walking], or biodiversity connectivity of around 100m stretches, identified by [@RANTA2021106980]. Our method reflects this balance, using satellite data for broader patterns such as LST and impervious surfaces. We then supplement this with higher-resolution sources for space syntax calculations, biotope values and ecologically valuable habitats, to name a few. The collected data for each respective goals can be found in the figures below.

```{r}
library(slickR)
imgs <- c("Inserted_images/data_biodiversity.png",
          "Inserted_images/climate_adaption.png",
          "Inserted_images/qualityoflife_datacollected.png")

slickR(imgs, height = 400, width = 700) +
  settings(dots = TRUE)

```

### Scale-Specific Indicators for Stream Assessment

Urban stream analysis requires scale-appropriate methodologies. Different ecosystem services or hydrological characteristics demand different spatial extents. [@RANTA2021106980] uses for example 100m stretches for biological assessments and 500m buffers for hydromorphilogical evaluations.

Therefore, when deciding on our scale, we considered our indicators and attempted to closely match them to retain a good representation of the spatial dynamics of the stream functions we aimed to analyze.

### Impact of Scale on Detectable Effects

The spatial resolution of the data we collected significantly shapes the analytical results. Averaging the data collected within the chosen 100 x 100m cells allows for generalized insights, which we found best fitting. It may however still obscure localized effects such as even smaller micro climatic benefits of tree clusters or linear vegetation elements. We chose the trade off that best fits our and balances detail with analytical feasibility.

// For the MCDA -\> add how we average and normalise values here?

### Normalization

The data used in this study comes from many different sources and uses different units as discussed above. Therefore, to compare them evenly, all values need to be brought to the same scale, and normalized in order to later conduct K-means clustering to discover appropriate typologies. We therefore could not use one method for all data normalization. Instead, each topic or data map uses its own way of normalizing respective to the data acquisition and availability. For climate adaptation, values like temperature and air pollution were compared to limits from the EU or WHO. For biodiversity, we used scales that show how suitable or rich an area is for nature. For quality of life, we used standards such as walking distances or access to green areas. Each method is explained in the following sections under their respective topic or map that they relate to.

### Climate Adaptation

### Biodiversity

#### Impervious Surface Percentage

Impervious surfaces prevent water infiltration and increase runoff and heat accumulation. High imperviousness is typically associated with poor ecological performance and higher flood/heat risks. For this reason we chose to following ranges when normalizing.

::: {.callout-note collapse="true"}
## Normalized Impervious Table

| Indicator | Low Risk Threshold (0) | High Risk Threshold (1) | Normalized Range (0–1) | Notes |
|---------------|---------------|---------------|---------------|---------------|
| Impervious Surface (%) | 0% | 80% | 0 – 1 | \>80% often found in dense urban cores; 0% = natural cover |
:::

#### NDVI (Normalized Difference Vegetation Index)

NDVI indicates vegetation health and coverage. The NDVI was collected from the Sentinel-2 satellite using bands 2, 3 and 8. Then the mean NDVI was computed based on a temporal range of the last 5 years(between 01-01-2020 and 01-01-2025), the resolution of final NDVI is 10 by 10m. Higher values correspond to greener, more vegetated areas, contributing to cooling and ecosystem benefits. An NDVI of \>0.6 is typical of healthy vegetation in temperate zones [@ozyavuz2015determination]. For this reason the following table shows our justified choice of NDVI range when normalizing.

::: {.callout-note collapse="true"}
## Normalized NDVI Table

| Indicator | Low Risk Threshold (0) | High Risk Threshold (1) | Normalized Range (0–1) | Notes |
|---------------|---------------|---------------|---------------|---------------|
| NDVI | 0.6 | 0.0 | 0 – 1 (inverted) | Values \>0.6 = dense vegetation; 0 = bare soil or built-up |
:::

#### Tree-cover Percentage

Tree cover density represents the percentage of land surface covered by trees within our chosen area of interest. This measure is normalized on a 0 to 1 scale, where 0 corresponds to \<25% tree cover and 1 corresponds to \>75% tree cover. This range was chose as lower tree cover densities (\<0.25) are linked to increased land surface temperatures and higher urban heat island effects, while higher densities (\>0.75) are associated with reduced temperatures and mitigation of urban heat [@morabito2021surface].

::: {.callout-note collapse="true"}
## Normalized Tree Cover Table
| Variable | Low Risk Threshold(0) | High Risk Threshold (1) | Notes |
|-----------------|-----------------|-----------------|----------------------|
| Tree Canopy Cover | \>75% | \<25% | 75% → 0 (low risk), 25% → 1 (high risk) |
:::

#### Mean Night-Time Land Surface Temperature (LST)

High night-time temperatures indicate poor cooling and urban heat retention. The LST was collected from the Terra & Aqua satellite from NASA. The temporal range of when the data collected was the average LST from the summer of 2022 (june to august), this range was taken due to data availability. This data was chosen as the resolution was the highest at 1 by 1 km. Risk increases with rising LST, especially during summer heatwaves. The following table below shows the range of data collected compared to the normalized range.

::: {.callout-note collapse="true"}
## Normalized Mean LST table

| Indicator | Low Risk Threshold (0) | High Risk Threshold (1) | Normalized Range (0–1) | Notes |
|---------------|---------------|---------------|---------------|---------------|
| Mean Night-Time LST (°C) | 11°C | 16°C | 0 – 1 | 30°C = common threshold for urban heat stress at night |
:::

### Quality of Life

#### Pollution Normalization

To ensure comparability across pollutants, all air quality indicators were normalized to a common scale between 0 and 1. The normalization is based on internationally recognized health guidelines from the World Health Organization [@who2021] and the European Union (Directive 2008/50/EC) [@eu_air_quality]. For PM₁₀, PM₂.₅, and NO₂, thresholds were defined using three reference points: half the WHO annual guideline value (representing minimal health risk), the WHO annual guideline value (health-based target), and the EU legal limit (regulatory maximum). For SO₂, BaP, and BzN, thresholds were determined using available EU targets or inspired by the Belgian national limits [@irceline2022]. All values were normalized using the upper bound of each category range to reflect worst case exposure levels for each grid cell. This approach allows consistent interpretation of long-term exposure risks across pollutants.

::: {.callout-note collapse="true"}
## Normalized Pollution table

| Pollutant | WHO 2021 Guideline (µg/m³) | EU Limit (µg/m³) | Low Risk Threshold (0) = ½ WHO | High Risk Threshold (1) = EU | Normalized Range (0–1) |
|------------|------------|------------|------------|------------|------------|
| PM2.5 | 5 | 20 | 2.5 | 20 | 0 – 1 |
| PM10 | 15 | 40 | 7.5 | 40 | 0 – 1 |
| NO₂ | 10 | 40 | 5 | 40 | 0 – 1 |
| BaP | *0.12 (indicative, EU)* | 1.0 | 0.06 | 1.0 | 0 – 1 |
| BzN | 0.2 *(WHO guideline)* | 1.0 *(assumed)* | 0.1 | 1.0 | 0 – 1 |
| SO₂ | 40 *(WHO 24h guideline)* | 125 *(EU 24h)* | 20 | 125 | 0 – 1 |
:::

A then example calculation in Qgis for SO2 would be:

::: {.callout-note collapse="true"}
## Example calculation for SO2

CASE WHEN "MAX_majority" IS NULL THEN NULL WHEN "MAX_majority" \< 20 THEN 0 WHEN "MAX_majority" \> 125 THEN 1 ELSE ("MAX_majority" - 20) / (125 - 20) END
:::

However, as was later discovered, this approach led to all of the pollution data being qualified as 0. Given the Czech data is categorized differently and is given as aggregated annual values, a choice was made to use the same range given with the data (and its associated colours) when normalizing. Given that our analysis is context specific, changing the normalization will highlight the range in air quality within our given site. Whether the air quality is below or above the recommended values will no longer become the basis.

This simpler method yields the final table with the new normalization based on the input data classification is the following.

::: {.callout-note collapse="true"}
## New Normalized Pollution Table

| Pollutant | Observed Max (From Layer) | Low Risk Threshold (0) | High Risk Threshold (1) | Normalization Formula |
|---------------|---------------|---------------|---------------|---------------|
| PM2.5 | 2.5 | 0 | 5 | `"MAX_max" / 2.5` |
| SO₂ | 2.5 | 0 | 5 | `"MAX_max" / 2.5` |
| BaP | 0.16 | 0 | 0.16 | `"MAX_max" / 0.16` |
| PM10 | 3 | 0 | 3 | `"MAX_max" / 3` |
| NO₂ | 3.5 | 0 | 3.5 | `"MAX_max" / 3.5` |
| BzN | 0.25 | 0 | 0.25 | `"MAX_max" / 0.25` |
:::

### MCDA

#### Maps

##### Biodiversity

![Basic Habitats along Bila Nisa](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Basic%20habitat%20mapping%20(broad%20categories).pdf) ![Detailed basic Habitats along Bila Nisa](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Basic%20habitat%20mapping.pdf)

![Zoning of large-scale protected areas](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Zoning%20of%20large-scale%20specially%20protected%20areas.pdf) ![Levels of protection in natural areas](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Levels%20of%20protection%20in%20large-scale%20specially%20protected%20natural%20areas%20(RED).png)

![Road segment length, potential for road kills animals](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Road%20segment%20length%20per%20cell.png)

![Types of greenery along Bila Nisa](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Types%20of%20greenery%20along%20B%C3%ADl%C3%A1%20Nisa.pdf)

![Build up area](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Build%20up%20area.png)

![Diversity of ecologically valuable habitats](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Diversity%20of%20ecologically%20valuable%20habitats-01.png)

![Ecological corridors](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Ecological%20corridors%20(%C3%9ASES).pdf) ![Ecological corridors normalized](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Ecological%20corridors-01.png) ![Ecologically valuable habitats](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Proportion%20of%20ecologicaly%20valuable%20habitats%20surface%20area.png)

![Categorization of flood plains](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Prevailing%20land-cover%20types%20(categorization%20of%20floodplains).pdf) ![Flood plain restoration](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Potential%20for%20natural%20floodplain%20restoration%20(categorization%20of%20floodplains).pdf) ![Biotopes along flood plains](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biotope%20value%20index%20(categorization%20of%20floodplains).pdf)

![Flood plain biotope value](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Floodplain%20biotope%20value-01.png) ![Natural flood plain restoration normalized](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Biodiversity/Potential%20for%20natural%20floodplain%20restoration-01.png)

##### Climate Adaptation

Need to add map of Ruofan

![Impervious surface](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Impervious_surface.pdf)

![Land surface temperature](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Land_surface_temp.pdf)

##### Quality of life

For quality of life, three main criteria have been developed according to the paper published by [@Khalil2017]: Availability of public amenities, accessibility of the area, and environmental indicators. Another indicator include socio-economic data on the population, however these have not been translated in vector data for the area of Jablonec nad Nisau and have therefore been excluded from this analysis.

For the first analysis, we look at the availability of essential public amenities like public functions and public green along the stream and how well accessible they are.

![Public amenities along Bila Nisa stream](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MAP%20-%20PUBLIC%20AMENITIES.png) ![Normalized map of public amenities](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Access%20public%20amenities%20along%20Bila%20Nisa.png) ![Map showing public green along Bila Nisa stream](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MAP%20-%20PUBLIC%20GREEN%20CLIP.png) ![Normalized map of public green availability along Bila Nisa](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Access%20to%20Public%20Green%20along%20Bila%20Nisa.png) Secondly, we analyzed how well the urban stream is connected to the urban area through the street network and availability of public transport.

![Angular integration of road network indicating local centers](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MAP%20-%20ROADS%20INTEGRATION.png) ![Nominal map showing accessiblity to urban centers](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Access%20through%20integrated%20roads%20along%20Bila%20Nisa.png) ![public transport access within stream area](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MAP%20-%20PUBLIC%20TRANSPORT.png) ![Access to public transport near the stream](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/Access%20Public%20Transport%20near%20Bila%20Nisa.png)

Air pollution maps ![Normalized BZP pollution](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20BZP.png) ![Normalized BAP map](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20BAP.png) ![SO2 pollution normalized](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20SO2.png) ![NO2 pollution normalized](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20NO2.png)

![Finedust PM10](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20PM10.png) ![Finedust PM25 normalized](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20PM25.png)

Urban heat stress ![Normalized tree cover percentage](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20treecoverpercentage.png) ![NDVI Map normalized](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/midtermmaps_frederick/Bila%20Nisa%20(A3%20map)%20NDVI.png)

#### Criteria Matrixes

Using the Saaty matrix, each criteria are weighted against each other to give each criterion a priority based on their importance for urban stream restoration. Each topic has its own matrix to create a consistent assessment.

![Biodiversity MCDA matrix](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MCDA%20Scores%20-%20Biodiversity.pdf)

![Climate Adaptation MCDA matrix](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MCDA%20Scores%20-%20Climate%20Adaptation.pdf)

![Quality of life MCDA matrix](http://rstudio-server-edu.bk.tudelft.nl:8787/files/report-asa2025-groupd/data_carpentry/fig_output/MCDA%20Scores%20-%20Quality%20of%20Life.pdf)


```{r fig.subcap="Jablonec nad Nisou and the Bila Nisa stream"}
#| warning: false
#| echo: false
#| message: false
library(leaflet)
library(sf)
library(dplyr)
library(RColorBrewer)
library(htmltools)

# Set center coordinates
jablonec_coords <- c(lat = 50.7224, lng = 15.1708)

# List of files (assumes they are in "data" folder)
files <- list.files("inserted_images/final_output_geopackages", pattern = "_final_newgrid\\.gpkg$", full.names = TRUE)

# Initialize map
m <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = jablonec_coords["lng"], lat = jablonec_coords["lat"], zoom = 14)

# For each GPKG file
for (file in files) {
  layer_name <- tools::file_path_sans_ext(basename(file))
  gdf <- st_read(file, quiet = TRUE) %>%
  st_transform(4326)
  
  # Drop geometry to find numeric columns between 0–1
  numeric_cols <- st_drop_geometry(gdf) %>%
    select(where(~ is.numeric(.x) && all(.x >= 0 & .x <= 1, na.rm = TRUE))) %>%
    colnames()

  # Assume only 1 normalized column per file
  if (length(numeric_cols) != 1) next  # skip if none or ambiguous
  norm_col <- numeric_cols[1]
  
  pal <- colorNumeric("YlGnBu", domain = gdf[[norm_col]], na.color = "transparent")

  m <- m %>% addPolygons(
    data = gdf,
    fillColor = ~pal(get(norm_col)),
    weight = 0.3,
    color = "#222222",
    opacity = 1,
    fillOpacity = 1,
    group = layer_name,
    label = ~paste0(layer_name, ": ", round(get(norm_col), 2)),
    options = pathOptions(className = "attribute-layer")  # custom class for filtering
  )
}

# Add layer control
m <- m %>% addLayersControl(
  overlayGroups = tools::file_path_sans_ext(basename(files)),
  options = layersControlOptions(collapsed = FALSE)
)

# Add brightness slider
slider <- tags$div(
  style = "position: absolute; top: 10px; right: 10px; z-index: 999; background: white; padding: 5px;",
  tags$label("Brightness:"),
  tags$input(id = "brightnessSlider", type = "range", min = 0.2, max = 1.5, step = 0.01, value = 1, style = "width: 150px;")
)

# Script to apply brightness only to polygon layers
script <- tags$script(HTML(
  "
  document.getElementById('brightnessSlider').addEventListener('input', function() {
    var brightness = this.value;
    var layers = document.querySelectorAll('.attribute-layer');
    layers.forEach(function(layer) {
      layer.style.filter = 'brightness(' + brightness + ')';
    });
  });
  "
))

# Render everything
htmltools::browsable(tagList(m, slider, script))



```


### Typology construction

## Results

## Discussion

## Conclusion

:::
